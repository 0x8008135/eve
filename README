# go-provision
Onboarding and provisioning client and mock server in go

The overall flow is as follows:
1. Install provisioning binaries and config files in /opt/zededa/bin
and /opt/zededa/etc
    # XXX check these are current
      scp -p prov01.priv.sc.zededa.net:/home/nordmark/go-provision.linux_arm64.tar.gz /tmp
OR
      scp -p prov01.priv.sc.zededa.net:/home/nordmark/go-provision.linux_x86_64.tar.gz /tmp

      cd /opt/
      sudo tar xf /tmp/go-provision.linux_*.tar.gz

   Install lisp in /opt/zededa/lisp
      mkdir /opt/zededa/lisp
      cd /opt/zededa/lisp
      # XXX not current
      wget https://www.dropbox.com/s/if22l9t0l0f3kt6/lispers.net-x86-release-0.373.tgz
      tar xf lispers.net-x86-release-0.373.tgz
      python -O /opt/zededa/lisp/lispers.net-install-ubuntu.pyo
      sudo apt-get install python-pip
      sudo pip install ecdsa==0.13
Check install with
      python -O /opt/zededa/lisp/lispers.net-test-install.pyo 

2. Generate an onboarding certificate (7 day lifetime) on the server and
   register it with the server.
   NOTE: For the device to be able to communicate with zedcontrol etc
   it must be in IID 85865 and the IID is based on a hash of the username.
   Thus the username below must be myself@zededa.net.
   (Down the road we'll have the ability to pick a project with an associated
   IID in the ZedCloud.)
   Example:
      ssh prov01.priv.sc.zededa.net
      cd /opt/zededa/bin/
      mkdir /tmp/`whoami`
      ./generate-onboard.sh /tmp/`whoami`/onboard
      ./register myself@zededa.com /tmp/`whoami`/onboard.cert.pem 3
   The above registration allows to use the onboarding certificate for 3 devices
   Generate-onboard produces two /tmp/`whoami`/onboard.*.pem files.
   Copy those files to your client device in /opt/zededa/etc/
      scp -p prov01.priv.sc.zededa.net:/tmp/`whoami`/onboard.\*.pem /opt/zededa/etc
      
   Then remove the private onboarding key and cert on the prov01 server:
      rm -rf /tmp/`whoami`/onboard*

Above steps are supposed to be done as part of the user requesting an
image for their device(s) at e.g. developer.zededa.com


3. Run through the provisioning steps on the device
   /opt/zededa/bin/device-steps.sh -w
   
   Note that if the clocks are not in sync between the device and the prov01
   server you'll see some errors and retries of the form:

   device-param statuscode 401 Unauthorized
   deviceCert too early NotBefore 2017-05-10 20:34:27 +0000 UTC, now 2017-05-10 13:33:42.990013239 -0700 PDT


====

Server config on prov01:
1. Create server config in /usr/local/etc/zededa-server containing the following files
   intermediate-ca-chain.pem  server.cert.pem  server.key.pem

2. Start the server on a laptop or server
   Example:
	env -u https_proxy env -u http_proxy go-provision/bin/server 


      
