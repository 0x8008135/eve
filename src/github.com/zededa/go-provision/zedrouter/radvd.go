// Copyright (c) 2017 Zededa, Inc.
// All rights reserved.

// radvd configlet for overlay interface towards domU

package main

import (
	"fmt"
	"log"
	"os"
	"os/exec"
)

// Need to fill in the overlay inteface name
const radvdTemplate = `
# Automatically generated by zedrouter
# Low preference to allow underlay to have high preference default
interface %s {
	IgnoreIfMissing on;
	AdvSendAdvert on;
	MaxRtrAdvInterval 1800;
	AdvManagedFlag on;
	AdvLinkMTU 1280;
	AdvDefaultPreference low;
	route fd00::/8
	{
		AdvRoutePreference high;
		AdvRouteLifetime 1800;
	};
};
`

// Create the radvd config file for the overlay
// Would be more polite to return an error then to Fatal
func createRadvdConfiglet(cfgPathname string, olIfname string) {
	fmt.Printf("createRadvdConfiglet: %s\n", olIfname)
	file, err := os.Create(cfgPathname)
	if err != nil {
		log.Fatal("os.Create for ", cfgPathname, err)
	}
	defer file.Close()
	file.WriteString(fmt.Sprintf(radvdTemplate, olIfname))
}

func deleteRadvdConfiglet(cfgPathname string) {
	fmt.Printf("createRadvdConfiglet: %s\n", cfgPathname)
	if err := os.Remove(cfgPathname); err != nil {
		log.Println("Remove ", cfgPathname, err)
	}
}

// Run this:
//    radvd -u radvd -C /etc/radvd.${OLIFNAME}.conf -p /var/run/radvd.${OLIFNAME}.pid
func startRadvd(cfgPathname string, olIfname string) {
	fmt.Printf("startRadvd: %s\n", cfgPathname)
	pidPathname := "/var/run/radvd." + olIfname + ".pid"
	cmd := "nohup"
	args := []string{
		"radvd",
		"-u",
		"radvd",
		"-C",
		cfgPathname,
		"-p",
		pidPathname,
	}
	go exec.Command(cmd, args...).Output()
}

//    pkill -u radvd -f radvd.${OLIFNAME}.conf
func stopRadvd(cfgFilename string, printOnError bool) {
	fmt.Printf("stopRadvd: %s\n", cfgFilename)
	pkillUserArgs("radvd", cfgFilename, printOnError)
}
